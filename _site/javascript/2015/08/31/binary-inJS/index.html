<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">

    <!-- viewport 설정 -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- keyword 설정 -->
    <meta name="keywords" content="javascript">
    <!-- description 설정 -->
    <meta name="description" content="JavaScript 를 통해 Binary Data 조작하기" />

    <!-- open graph 설정 -->
    <meta property="og:type" content="mohwa blog">
    <meta property="og:title" content="JavaScript 를 통해 Binary Data 조작하기">
    <meta property="og:description" content="JavaScript 를 통해 Binary Data 조작하기">
    <!--<meta property="og:image" content="http://mysite.com/myimage.jpg">-->
    <meta property="og:url" content="/blog">

    <meta name="copyright" content="by mohwa" />

    <!--<link href="/favicon.ico" rel="shortcut icon" type="image/x-icon" />-->

    <!-- google search console 설정 -->
    <link rel="alternate" hreflang="ko" href="http://mohwa.github.io" />
    <link rel="alternate" hreflang="ko" href="https://mohwa.github.io" />

    <link rel="stylesheet" href="/blog/assets/css/site.css" />
    <link rel="stylesheet" href="/blog/bower_components/highlightjs/styles/darkula.css">

    <script src="/blog/bower_components/jquery/dist/jquery.min.js" type="text/javascript"></script>
    <script src="/blog/bower_components/highlightjs/highlight.pack.min.js" type="text/javascript"></script>
    <script src="/blog/bower_components/purl/purl.js" type="text/javascript"></script>
    <!-- Script pointing to jekyll-search.js -->
    <script src="/blog/bower_components/simple-jekyll-search/dest/jekyll-search.js" type="text/javascript"></script>

    <title>JavaScript 를 통해 Binary Data 조작하기</title>

    <script type="text/javascript">

        // code highlight 적용
        // https://highlightjs.org/static/demo/
        $(document).ready(function() {
            $('pre code').each(function(i, block) {
                hljs.highlightBlock(block);
            });
        });
    </script>
</head>

<body>

  <div class="top-bar"></div>

  <div class="container">
    <div class="site">
      <header>
        <nav>
    <span style="float:left;">
        <a class="" href="/blog/">Home</a>
        <!--<a class="" href="/archive/">전체글</a>-->
        <!--<a class="" href="//github.com/nolboo/nolboo.github.io/wiki">번역글 위키</a>-->
    </span>
    <span style="float:right;">
        <div id="search-container" class="search-container">
            <input type="text" id="search-input" class="search-input" placeholder="search...">
        </div>
    </span>
</nav>

        <div class="pull-right right logo">
          <div class="name"></div>
          <!--<a href="/feed.xml"><img class="avatar" src="/images/rss.jpg" alt="RSS" /></a>-->
        </div>
      </header>
      <div class="separator"></div>
      <ul id="results-container" class="results-container"></ul>
      <article>
  <h1>
    JavaScript 를 통해 Binary Data 조작하기
  </h1>
  <div class="center">
    <p class="meta">31 Aug 2015</p>
  </div>



  <div class="post">
  <h2 id="1">1. 사전 지식</h2>

<ul>
<li><p><strong>Blob</strong></p>

<ul>
<li>정의

<ul>
<li><strong>Blob</strong> 는 일반적으로 미디어(이미지, 사운드, 비디오) 파일과 같은 큰 용량의 파일을 말한다.</li>
</ul></li>
<li><p>Blob Object</p>

<ul>
<li><p>Blob Object 는 File 과 같은 <strong>불변 객체</strong>를 나타내며, <strong>raw data</strong> 를 가진다.</p>

<ul>
<li>추가로 <span style="color:#6298c1">File 인터페이스</span> 는 <strong>Blob 인터페이스</strong> 의 모든 특성들을 상속받는다.</li>
</ul>

<p><img src="http://mohwa.github.io/blog/assets/images/posts/bytesManipulation_1.jpg" alt=""></p></li>
</ul></li>
<li><p><a href="https://developer.mozilla.org/en/docs/Web/API/Blob">Blob API in MDN</a></p></li>
<li><p><a href="http://www.terms.co.kr/BLOB.htm">Blob in Terms</a></p></li>
<li><p><a href="http://caniuse.com/#search=blob">Blob in Can I Use</a></p></li>
</ul></li>
<li><p><strong>JavaScript Typed Array</strong></p>

<ul>
<li><p>정의</p>

<ul>
<li><p><strong>Typed Array</strong> 는 raw binary data 에 접근하기 위한 방법을 제공한다.</p>

<ul>
<li><em>즉 자바스크립트로 <span style="color:#c11f1f">binary data</span> 를 다루기 위해 사용한다.</em></li>
</ul></li>
<li><p><strong>유연성</strong>과 <strong>효율성</strong>을 위해 <span style="color:#c11f1f">buffer</span> 와 <span style="color:#c11f1f">view</span> 로 나눠 구현되어있다.</p>

<ul>
<li><p>buffer</p>

<ul>
<li><span style="color:#6298c1">ArrayBuffer</span> 는 고정된 크기의 raw binary data 를 나타내기 위해 사용된다.</li>
<li><p><span style="color:#6298c1">ArrayBuffer</span> 클래스 통해 생성된  <span style="color:#c11f1f">buffer</span> 는 <strong>데이터 청크</strong>를 나타내는 객체이다.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// 12 bytes buffer 나타낸다</span>
<span class="kd">var</span> <span class="nx">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span>
</code></pre></div></li>
<li><p><span style="color:#c11f1f">buffer</span> 는 <u>저장된 <strong>데이터</strong>를 접근하기 위한 방법을 제공하지 않는다.</u></p></li>
<li><p>데이터를 다루기 위해서는 반드시 <span style="color:#c11f1f">view</span> 를 사용해야한다.</p></li>
</ul></li>
<li><p>view</p>

<ul>
<li><p>DataView</p>

<p><span style="color:#6298c1">DataView</span> <span style="color:#c11f1f">view</span> 는 <span style="color:#c11f1f">buffer</span> 에 저장된 데이터로 부터 값을 <strong>읽고</strong>, <strong>쓰기</strong> 위한 <span style="color:#6298c1">low-level 인터페이스</span> 를 제공한다.(getter/setter API 제공)</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// 12 bytes byffer</span>
<span class="kd">var</span> <span class="nx">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span>
<span class="c1">// view 를 생성한다.</span>
<span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DataView</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

<span class="c1">// 해당 view 가 시작하는 위치를 반환한다.</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">view</span><span class="p">.</span><span class="nx">byteOffset</span><span class="p">);</span> <span class="c1">// 2</span>
</code></pre></div>
<p>데이터를 다루기위한 DataView 의 특성들은 아래와 같다.</p>

<p><img src="http://mohwa.github.io/blog/assets/images/posts/bytesManipulation_4.jpg" alt=""></p></li>
<li><p><span style="color:#6298c1">Typed Array Views</span></p>

<p><span style="color:#6298c1">DataView</span> 를 상속한 아래 <strong>클래스</strong>들을 통해 <span style="color:#c11f1f">buffer</span> 에 저장된 데이터를 다룰 수 있게된다.</p>

<p><strong>Int8Array</strong>, <strong>Uint8Array</strong>, <strong>Int32Array</strong>, <strong>Uint32Array</strong> 등 ...</p>

<p>위 클래스 중 <span style="color:#6298c1">Int32Array</span> 를 통해 생성된 <span style="color:#c11f1f">view</span> 는 아래와 같은 특성들을 가지게된다.</p>

<p><img src="http://mohwa.github.io/blog/assets/images/posts/bytesManipulation_3.jpg" alt=""></p>

<p>아래 그림은 각 <span style="color:#c11f1f">view</span> 에 따라 나눠지는 메모리 공간을 나타낸다.</p>

<p><img src="http://mohwa.github.io/blog/assets/images/posts/bytesManipulation_2.jpg" alt=""></p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="cm">/*</span>

<span class="cm">ArrayBuffer(20 bytes)</span>
<span class="cm">8bit == 1 byte</span>

<span class="cm">ArrayBuffer / 1 byte = 20;</span>

<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
<span class="c1">// 부호 없는 1 byte 정수 배열</span>
<span class="kd">var</span> <span class="nx">uint8View</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">buffer</span><span class="p">);</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">uint8View</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span> <span class="c1">// 20</span>

<span class="cm">/*</span>

<span class="cm"> ArrayBuffer(20 bytes)</span>
<span class="cm"> 32bit == 4 byte</span>

<span class="cm"> ArrayBuffer / 4 byte = 5;</span>

<span class="cm"> */</span>

<span class="kd">var</span> <span class="nx">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
<span class="c1">// 부호 없는 4 byte 정수 배열</span>
<span class="kd">var</span> <span class="nx">uint32View</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint32Array</span><span class="p">(</span><span class="nx">buffer</span><span class="p">);</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">uint32View</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span> <span class="c1">// 5</span>
</code></pre></div>
<p>unsigned or signed view test</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// unsigned int 8(1 bytes)</span>

<span class="kd">var</span> <span class="nx">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">uint8View</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">buffer</span><span class="p">);</span>

<span class="c1">// 0 ~ 255(unsigned int 8(1 bytes) 로 표현 가능한 수)</span>
<span class="nx">uint8View</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nx">uint8View</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">uint8View</span><span class="p">);</span> <span class="c1">// [0, 255, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]</span>

<span class="c1">// signed int 8(1 bytes)</span>

<span class="kd">var</span> <span class="nx">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">int8View</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Int8Array</span><span class="p">(</span><span class="nx">buffer</span><span class="p">);</span>

<span class="c1">// -127 ~ 128(signed int 8(1 bytes) 로 표현 가능한 수)</span>

<span class="c1">// signed 의 경우 부호(양수/음수)를 나타내기 위해 총 8bit 중 1 비트(0: 양수, 1: 음수) 사용하기 때문에, 나머지 7bit(-127 ~ 128(표현 가능한 수))를 통해 숫자를 표현하게 된다.</span>

<span class="nx">int8View</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">128</span><span class="p">;</span>
<span class="nx">int8View</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">127</span><span class="p">;</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">int8View</span><span class="p">);</span> <span class="c1">// [-128, 127, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]</span>

<span class="c1">// unsigned int 16(2 bytes)</span>
<span class="kd">var</span> <span class="nx">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">uint16View</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint16Array</span><span class="p">(</span><span class="nx">buffer</span><span class="p">);</span>

<span class="c1">// 0 ~ 65535(unsigned int 16(2 bytes) 로 표현 가능한 수)</span>
<span class="nx">uint16View</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">65535</span><span class="p">;</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">uint16View</span><span class="p">);</span> <span class="c1">// [65535, 0, 0, 0, 0, 0, 0, 0, 0, 0]</span>
</code></pre></div></li>
</ul></li>
</ul></li>
<li><p><a href="https://developer.mozilla.org/ko/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer">ArrayBuffer</a></p></li>
<li><p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/DataView">DataView</a></p></li>
<li><p><a href="http://www.javascripture.com/DataView">DataView API Test</a></p></li>
<li><p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Typed_arrays">JavaScript Typed Arrays</a></p></li>
<li><p><a href="http://ohgyun.com/418">JavaScript Typed Arrays(번역)</a></p></li>
<li><p><a href="http://firejune.com/1791/">signed 와 unsigned 의 차이</a></p></li>
<li><p><a href="http://air802.tistory.com/52">signed 가 음수 표현하는 방법(상세 설명)</a></p></li>
<li><p><a href="http://libsora.so/posts/i-hate-unsigned/">나는 unsigned 가 싫어요</a></p></li>
<li><p><a href="http://blog.naver.com/dud5243_/220415835594">signed or unsigned 자료형의 범위</a></p></li>
<li><p><a href="http://www.binaryconvert.com/index.html">Binary Convert</a></p></li>
</ul></li>
</ul></li>
<li><p><strong>Little-Endian or Big-Endian</strong></p>

<ul>
<li><p>정의</p>

<ul>
<li><span style="color:#6298c1">Endian</span> 은 컴퓨터에서 데이터가 저장되는 순서(<span style="color:#c11f1f">byte order</span>)를 말한다.</li>
<li><img src="http://mohwa.github.io/blog/assets/images/posts/bytesManipulation_5.jpg" alt=""></li>
<li><p>정리:</p>

<ul>
<li>메모리는 <span style="color:#c11f1f">하위 주소</span>에서 <span style="color:#c11f1f">상위 주소</span>로 데이터가 저장된다.</li>
<li><p><span style="color:#c11f1f">Little Endian</span>: <span style="color:#6298c1">하위 바이트</span>부터 데이터가 저장되는 방식.</p>

<ul>
<li><span style="color:#c11f1f">Little Endian</span> 방식의 장점: 산술연산유닛(ALU)에서 메모리를 읽는 방식이 메모리 주소가 낮은 쪽에서부터 높은 쪽으로 읽기 때문에 산술 연산의 수행이 더 쉽다.(<em>연산 처리 과정에서 이런 장점이 있는 정도로만 알고 넘어가자...</em>)</li>
</ul></li>
<li><p><img src="http://mohwa.github.io/blog/assets/images/posts/bytesManipulation_6.jpg" alt=""></p></li>
<li><p><span style="color:#c11f1f">Big Endian</span>: <span style="color:#6298c1">상위 바이트</span>부터 데이터가 저장되는 방식.</p></li>
<li><p><img src="http://mohwa.github.io/blog/assets/images/posts/bytesManipulation_7.jpg" alt=""></p></li>
</ul></li>
</ul></li>
<li><p>적용 이유:</p>

<ul>
<li>각 <u><strong>CPU</strong>(Intel / Spac) <strong>타입</strong>에 따라 <span style="color:#6298c1">차이</span>를 보이는 <span style="color:#c11f1f">byte order</span>(<strong>데이터 저장 순서</strong>)</u>는, 동일한 시스템 안에서만 데이터를 주고 받는다면, <span style="color:#c11f1f">Endian</span> 에 대해 전혀 신경쓸 필요가 없지만, <u><span style="color:#6298c1">이기종간</span>에 데이터를 주고 받을 경우</u>, 서로간의 <strong>데이터 저장 방식 차이</strong>로 인해 전혀 엉뚱한 결과를 반환하게 된다.</li>
</ul></li>
<li><p>서로 다른 Endian 간의 데이터 통신 해결책:</p>

<ul>
<li><p>공통되는 Endian(<u>약속된 <span style="color:#c11f1f">Endian</span> 규칙</u>)으로 <span style="color:#6298c1">변환</span> 후, 데이타를 주고/받는 방법.</p>

<ul>
<li>즉 서로간에 사용할 <strong>Endian</strong>(<span style="color:#c11f1f">Little Endian</span> or <span style="color:#c11f1f">Big Endian</span>) 을 하나로 통일시켜 데이터를 주고 받는 것이다.</li>
</ul></li>
<li><p>또 하나의 방법은 <span style="color:#c11f1f">byte order</span>(바이트 저장 순서) 를 신경쓸 필요가 없는, <strong>데이터 타입</strong>을 사용하는 것이다. <span style="color:#c11f1f">char</span> 타입은 <strong>1byte</strong> 의 크기를 가지기때문에, <span style="color:#c11f1f">byte order</span> 에 대해 전혀 신경쓸 필요가 없다. 예를 들면 12345678 을 int 형으로 보내는 대신 <strong>문자열</strong> &quot;12345678&quot; 로 변환시켜 <span style="color:#6298c1">전송</span>하면 된다.</p></li>
</ul></li>
<li><p><a href="https://ko.wikipedia.org/wiki/%EC%97%94%EB%94%94%EC%96%B8">엔디언</a></p></li>
<li><p><a href="http://t3zz-so4.tistory.com/entry/Little-Endian-Big-Endian">Little-Endian or Big-Endian(개념 잡기 좋은 문서)</a></p></li>
<li><p><a href="http://firejune.com/1790">Little-Endian or Big-Endian 개념</a></p></li>
<li><p><a href="http://www.joinc.co.kr/modules/moniwiki/wiki.php/Site/Network_Programing/Documents/">Endian 에 대해서</a></p></li>
</ul></li>
</ul>

<h2 id="2-javascript-binary-data">2. JavaScript 를 통해 Binary Data 조작하기</h2>

<ul>
<li><p><span style="color:#6298c1">예제 소스</span>에서는 <strong>NodeJS</strong> 및 <strong>Socket.IO</strong> 와 관련된 내용은 최대한 배제 하였습니다.(특별히 포스트 내용과 관련 없다고 판단한 내용)</p></li>
<li><p><strong>파일 업로드</strong></p>

<ul>
<li><p><span style="color:#6298c1">File</span> 및 <span style="color:#6298c1">FileReader API</span> 를 지원하는 브라우저를 통해 파일 업로드 기능을 만들 수 있다.</p>

<ul>
<li>하지만 <em>IE(10/11 포함) 브라우저는 지원하지 않는다고 보면된다.</em></li>
<li><p>Source Example</p>

<ul>
<li>Cliend Side(use JS)</li>
<li><p>먼저 저장소로 부터 내려받은 파일을 include 한다.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="o">&lt;</span><span class="nx">script</span> <span class="nx">src</span><span class="o">=</span><span class="s2">&quot;siofu_client.js&quot;</span><span class="o">&gt;&lt;</span><span class="err">/script&gt;</span>
</code></pre></div><div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// socket 서버에 연결</span>
<span class="kd">var</span> <span class="nx">socket</span> <span class="o">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s1">&#39;http://localhost:9090&#39;</span><span class="p">);</span>

<span class="c1">// socket 객체를 SocketIOFileUpload 클래스로 전달한다.</span>
<span class="kd">var</span> <span class="nx">uploader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SocketIOFileUpload</span><span class="p">(</span><span class="nx">socket</span><span class="p">);</span>

<span class="c1">// listenOnSubmit 메서드에 input[type=&quot;button&quot;] 및 input[type=&quot;file&quot;] Element 를 전달한다.</span>
<span class="nx">uploader</span><span class="p">.</span><span class="nx">listenOnSubmit</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#btn_upload&#39;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#siofu_input&#39;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>

<span class="c1">// KiB === byte 단위</span>
<span class="c1">// KB === KByte 단위</span>

<span class="c1">// 한번에 로드될 chunks 파일 사이즈</span>
<span class="c1">// chunkSize 를 0으로 할당하면, chunk 를 사용하지 않게 된다.</span>
<span class="nx">uploader</span><span class="p">.</span><span class="nx">chunkSize</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">100</span><span class="p">;</span> <span class="c1">// 102400 byte 로 chunk 단위를 나눈다.</span>

<span class="nx">uploader</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">){</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;started upload of file&#39;</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// progress 이벤트를 통해 현재 진행 상황을 볼 수 있다.</span>
<span class="nx">uploader</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;progress&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">percent</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">bytesLoaded</span> <span class="o">/</span> <span class="nx">event</span><span class="p">.</span><span class="nx">file</span><span class="p">.</span><span class="nx">size</span> <span class="o">*</span> <span class="mi">100</span><span class="p">;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;File is&quot;</span><span class="p">,</span> <span class="nx">percent</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;percent loaded&quot;</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// 파일 업로드가 끝날을때 이벤트가 발생한다.</span>
<span class="nx">uploader</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;complete&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">){</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;completed file upload&#39;</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></li>
<li><p>Server Side(use nodeJS)</p></li>
</ul>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript">    <span class="kd">var</span> <span class="nx">uploader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">siofu</span><span class="p">();</span>
    <span class="nx">uploader</span><span class="p">.</span><span class="nx">dir</span> <span class="o">=</span> <span class="s2">&quot;uploads&quot;</span><span class="p">;</span>
    <span class="nx">uploader</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">socket</span><span class="p">);</span>

    <span class="c1">// Do something when a file is saved:</span>
    <span class="nx">uploader</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;saved&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">){</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">file</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="c1">// Error handler:</span>
    <span class="nx">uploader</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">){</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Error from uploader&quot;</span><span class="p">,</span> <span class="nx">event</span><span class="p">);</span>
    <span class="p">});</span>
</code></pre></div></li>
<li><p>참고 사이트</p>

<p><a href="https://github.com/vote539/socketio-file-upload#instancelistenoninputinput">socket io file upload module</a></p>

<p><a href="http://caniuse.com/#search=file%20api">File API</a></p>

<p><a href="http://caniuse.com/#search=FileReader">FileReader API</a></p></li>
</ul></li>
</ul></li>
<li><p><strong>이미지 효과</strong></p>

<ul>
<li>서버에서 내려받은 <span style="color:#6298c1">ArrayBuffer</span>(<strong>이미지</strong> 데이터) 로 <span style="color:#c11f1f">view</span>(uInt8Array) 를 생성 후, 버퍼에 저장된 데이터를 조작한다.</li>
<li><p>Source Example</p>

<ul>
<li><p>Cliend Side(use JS)</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">cw</span> <span class="o">=</span> <span class="mi">327</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">ch</span> <span class="o">=</span> <span class="mi">125</span><span class="p">;</span>

<span class="c1">// canvas Element 를 가져온다.</span>
<span class="kd">var</span> <span class="nx">canvas</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;canvas&#39;</span><span class="p">);</span>

<span class="c1">// context 를 생성한다.</span>
<span class="kd">var</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s1">&#39;2d&#39;</span><span class="p">);</span>

<span class="c1">// view(부호 없는 1byte 정수 배열)를 생성한다.</span>
<span class="kd">var</span> <span class="nx">uInt8Array</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">payload</span><span class="p">.</span><span class="nx">buffer</span><span class="p">);</span>

<span class="c1">// view를 통해 Blob Object 를 생성한다.</span>
<span class="kd">var</span> <span class="nx">blob</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Blob</span><span class="p">([</span><span class="nx">uInt8Array</span><span class="p">],</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;image/jpeg&#39;</span><span class="p">});</span>

<span class="kd">var</span> <span class="nx">originalImgData</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

<span class="c1">// Blob Object를 참조하는 URL를 생성한다.</span>
<span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">URL</span><span class="p">.</span><span class="nx">createObjectURL</span><span class="p">(</span><span class="nx">blob</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">img</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Image</span><span class="p">;</span>

<span class="c1">// 이미지 로드 이벤트</span>
<span class="nx">$</span><span class="p">(</span><span class="nx">img</span><span class="p">).</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;load&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">img</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
    <span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">img</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>

    <span class="c1">// 캔버스에 해당 이미지를 그린다.</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="nx">img</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">img</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">img</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>

    <span class="c1">// 각 px 에 대한 정보(r,g,b,a)가 담긴 이미지 데이터를 가져온다.</span>
    <span class="nx">originalImgData</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">getImageData</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>

    <span class="c1">// 반전 효과를 준다.</span>
    <span class="c1">// invert();</span>

    <span class="c1">// 흑백 효과를 준다.</span>
    <span class="nx">empty</span><span class="p">();</span>
<span class="p">});</span>

<span class="c1">// Blob 객체를 참조하는 URL을 img.src 에 할당 후 로드한다.</span>
<span class="nx">img</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span>

<span class="c1">// px 단위의 이미지 데이터를 조작하여, 반전 효과를 준다.</span>
<span class="kd">function</span> <span class="nx">invert</span><span class="p">(){</span>

    <span class="nx">originalImgData</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">getImageData</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">originalImgData</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>

        <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span> <span class="o">-</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>     <span class="c1">// red</span>
        <span class="nx">data</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span> <span class="o">-</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span> <span class="c1">// green</span>
        <span class="nx">data</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span> <span class="o">-</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span> <span class="c1">// blue</span>
    <span class="p">}</span>

    <span class="nx">ctx</span><span class="p">.</span><span class="nx">putImageData</span><span class="p">(</span><span class="nx">originalImgData</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">));</span>
<span class="p">};</span>

<span class="c1">// px 단위의 이미지 데이터를 조작하여, 흑백 효과를 준다.</span>
<span class="kd">function</span> <span class="nx">empty</span><span class="p">(){</span>

    <span class="nx">originalImgData</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">getImageData</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">originalImgData</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// 각 픽셀의 밝기만 조사하여 R, G, B 색상 요소를 균일하게 만들면 회색이 된다.(색상 정보를 아래 공식(각 요소(R, G, B)가 밝기에 미치는 영향은 29:58:11로 전문가에 의해 계산되어 있다)으로 R,G,B 요소에서 제거한다)</span>

        <span class="c1">// 128 이상은 흰색으로, 128 이하는 검정색으로 만들어 버림으로써, 흰색과 검정색 두 가지만 남긴다. 경계값인 128을 조정하면 밝기가 달라진다.</span>
        <span class="kd">var</span> <span class="nx">gray</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.299</span> <span class="o">+</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.587</span> <span class="o">+</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.114</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">gray</span> <span class="o">&gt;</span> <span class="mi">128</span><span class="p">){</span>
            <span class="nx">gray</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span><span class="p">{</span>
            <span class="nx">gray</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">gray</span><span class="p">;</span>     <span class="c1">// red</span>
        <span class="nx">data</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">gray</span><span class="p">;</span> <span class="c1">// green</span>
        <span class="nx">data</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nx">gray</span><span class="p">;</span> <span class="c1">// blue</span>
    <span class="p">}</span>

    <span class="nx">ctx</span><span class="p">.</span><span class="nx">putImageData</span><span class="p">(</span><span class="nx">originalImgData</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div></li>
<li><p>Server Side(use nodeJS)</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">);</span>

<span class="c1">// 파일을 읽은 후 클라이언트로 버퍼를 전달한다.</span>
<span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s1">&#39;./lib/img/nmms_20823487.jpg&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">buf</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// it&#39;s possible to embed binary data</span>
    <span class="c1">// within arbitrarily-complex objects</span>
    <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;onSocketMsg&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;resultImageData&#39;</span><span class="p">,</span>
        <span class="nx">payload</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">buffer</span><span class="o">:</span> <span class="nx">buf</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></li>
</ul></li>
<li><p>적용 결과</p>

<ul>
<li><p>원본 이미지</p>

<p><img src="http://mohwa.github.io/blog/assets/images/posts/bytesManipulation_8.jpg" alt=""></p></li>
<li><p>invert 함수 적용 이미지</p>

<p><img src="http://mohwa.github.io/blog/assets/images/posts/bytesManipulation_9.jpg" alt=""></p></li>
<li><p>empty 함수 적용 이미지</p>

<p><img src="http://mohwa.github.io/blog/assets/images/posts/bytesManipulation_10.jpg" alt=""></p></li>
</ul></li>
<li><p>참고 사이트</p>

<ul>
<li><a href="chrome://blob-internals/">생성된 Blob 객체 확인(in Chrome)</a></li>
<li><a href="http://caniuse.com/#search=createObjectURL">Blob URLs</a></li>
<li><a href="http://code.flickr.net/2012/06/01/parsing-exif-client-side-using-javascript-2/">EXIF(이미지 정보) IN JS</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API/Tutorial/Pixel_manipulation_with_canvas">Pixel manipulation with canvas</a></li>
<li><a href="http://www.phpied.com/pixel-manipulation-in-canvas/">Pixel manipulation in canvas(이미지 효과에 대한 예제 및 자세한 설명)</a></li>
<li><a href="http://www.soen.kr/html5/html3/3-2-2.htm">이미지 데이터 효과(한글 문서)</a></li>
</ul></li>
</ul></li>
<li><p><strong>ArrayBuffer 로 내려받은 비디오 플레이</strong></p>

<ul>
<li><p>서버에서 내려받은 <span style="color:#6298c1">ArrayBuffer</span>(<strong>영상</strong> 데이터) 로 <span style="color:#c11f1f">view</span>(in Typed Array Views) 를 생성 후, 버퍼에 저장된 데이터를 조작한다.</p>

<ul>
<li><strong>영상</strong> 및 오디오 데이터의 경우, <span style="color:#c11f1f">브라우저 지원 여부</span> 및 <span style="color:#c11f1f">지원 포맷</span>에 대해 반드시 확인해봐야한다.</li>
<li>아래 소스는 <span style="color:#6298c1">Chrome</span> 브라우저에서 <strong><code>*</code>.mp4</strong> 및 <strong><code>*</code>.webm</strong> 포맷으로만 테스트되었습니다.</li>
</ul></li>
<li><p>Source Example</p>

<ul>
<li><p>Cliend Side(use JS)</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">vw</span> <span class="o">=</span> <span class="mi">327</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">vh</span> <span class="o">=</span> <span class="mi">125</span><span class="p">;</span>

<span class="c1">// video Element 를 가져온다.</span>
<span class="kd">var</span> <span class="nx">video</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;video&#39;</span><span class="p">);</span>
<span class="nx">video</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">vw</span><span class="p">;</span>
<span class="nx">video</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">vh</span><span class="p">;</span>

<span class="c1">// view(부호 없는 1byte 정수 배열)를 생성한다.</span>
<span class="kd">var</span> <span class="nx">uInt8Array</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">payload</span><span class="p">.</span><span class="nx">buffer</span><span class="p">);</span>

<span class="c1">// view를 통해 Blob Object 를 생성한다.</span>
<span class="kd">var</span> <span class="nx">blob</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Blob</span><span class="p">([</span><span class="nx">uInt8Array</span><span class="p">],</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;video/webm&#39;</span><span class="p">});</span>
<span class="c1">//var blob = new Blob([uInt8Array], {type: &#39;video/mp4&#39;});</span>

<span class="c1">// Blob Object를 참조하는 URL 를 생성한다.</span>
<span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">URL</span><span class="p">.</span><span class="nx">createObjectURL</span><span class="p">(</span><span class="nx">blob</span><span class="p">);</span>

<span class="c1">// Blob 객체를 참조하는 URL을 video.src 에 할당 후 로드한다.</span>
<span class="nx">video</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span>
</code></pre></div></li>
<li><p>Server Side(use nodeJS)</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s1">&#39;redcliff450.webm&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">buf</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;onSocketMsg&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;resultVideoData&#39;</span><span class="p">,</span>
        <span class="nx">payload</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">buffer</span><span class="o">:</span> <span class="nx">buf</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></li>
</ul></li>
</ul></li>
<li><p><strong>Chunk 방식으로 내려받은 비디오 플레이</strong></p>

<ul>
<li>서버에서 Chunk 방식으로 내려받은 <span style="color:#6298c1">ArrayBuffer</span>(<strong>영상</strong> 데이터) 로 <span style="color:#c11f1f">view</span>(in Typed Array Views) 를 생성 후, 버퍼에 저장된 데이터를 조작한다.</li>
<li><span style="color:#6298c1">MediaSource API</span> 를 통해 내려받은 영상 데이터를 조작할 수 있다.</li>
<li><strong>영상</strong> 및 오디오 데이터의 경우, <span style="color:#c11f1f">브라우저 지원 여부</span> 및 <span style="color:#c11f1f">지원 포맷</span>에 대해 반드시 확인해봐야한다.</li>
<li>아래 소스는 <span style="color:#6298c1">Chrome</span> 브라우저에서 <strong><code>*</code>.webm</strong>(vorbis 및 vp8 코덱) 포맷으로만 테스트되었습니다.</li>
<li><p>Source Example</p>

<ul>
<li>Cliend Side(use JS)</li>
<li><p>저장소로 부터 내려받은 파일을 include 한다.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="o">&lt;</span><span class="nx">script</span> <span class="nx">src</span><span class="o">=</span><span class="s2">&quot;socket.io-stream.js&quot;</span><span class="o">&gt;&lt;</span><span class="err">/script&gt;</span>
</code></pre></div><div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// stream 메서드에 socket 객체를 전달 후 해당 이벤트를 바인딩한다.</span>
<span class="nx">ss</span><span class="p">(</span><span class="nx">socket</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;onSocketMsg&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">data</span> <span class="o">=</span> <span class="nx">data</span> <span class="o">||</span> <span class="p">{};</span>

    <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">payload</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">payload</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;resultChunkVideoData&#39;</span><span class="p">)</span> <span class="p">{</span>

        <span class="kd">var</span> <span class="nx">vw</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">vh</span> <span class="o">=</span> <span class="mi">768</span><span class="p">;</span>

        <span class="c1">// video Element 를 가져온다.</span>
        <span class="kd">var</span> <span class="nx">video</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;video&#39;</span><span class="p">);</span>
        <span class="nx">video</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">vw</span><span class="p">;</span>
        <span class="nx">video</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">vh</span><span class="p">;</span>

        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">payload</span><span class="p">.</span><span class="nx">stream</span><span class="p">);</span> <span class="c1">// 내려받은 stream 데이터</span>

        <span class="c1">// MediaSource 객체를 생성한다.</span>
        <span class="kd">var</span> <span class="nx">ms</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MediaSource</span><span class="p">();</span>

        <span class="c1">// MediaSource 객체를 참조하는 URL 를 생성한다.</span>
        <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">URL</span><span class="p">.</span><span class="nx">createObjectURL</span><span class="p">(</span><span class="nx">ms</span><span class="p">);</span>

        <span class="c1">// MediaSource 객체를 참조하는 URL을 video.src 에 할당 후 로드한다.</span>
        <span class="nx">video</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span>

        <span class="c1">// MediaSource 객체에 각 이벤트를 바인딩 시킨다.</span>
        <span class="nx">ms</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;sourceopen&#39;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
        <span class="c1">// ms.addEventListener(&#39;webkitsourceopen&#39;, callback, false);</span>
        <span class="nx">ms</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;sourceended&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;mediaSource readyState: &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="p">);</span>
        <span class="p">},</span> <span class="kc">false</span><span class="p">);</span>

        <span class="kd">function</span> <span class="nx">callback</span><span class="p">()</span> <span class="p">{</span>

            <span class="c1">// 재생하려는 영상 소스를 추가한다.</span>
            <span class="kd">var</span> <span class="nx">sourceBuffer</span> <span class="o">=</span> <span class="nx">ms</span><span class="p">.</span><span class="nx">addSourceBuffer</span><span class="p">(</span><span class="s1">&#39;video/webm; codecs=&quot;vp8&quot;&#39;</span><span class="p">);</span>
            <span class="c1">// var sourceBuffer = ms.addSourceBuffer(&#39;video/webm; codecs=&quot;vp8,vorbis&quot;&#39;);</span>

            <span class="nx">sourceBuffer</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;updatestart&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// console.log(&#39;updatestart: &#39; + ms.readyState);</span>
            <span class="p">});</span>

            <span class="nx">sourceBuffer</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="c1">// console.log(&#39;update: &#39; + ms.readyState);</span>
            <span class="p">},</span> <span class="kc">false</span><span class="p">);</span>

            <span class="nx">sourceBuffer</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;updateend&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;updateend: &#39;</span> <span class="o">+</span> <span class="nx">ms</span><span class="p">.</span><span class="nx">readyState</span><span class="p">);</span>
            <span class="p">});</span>
            <span class="nx">sourceBuffer</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;error: &#39;</span> <span class="o">+</span> <span class="nx">ms</span><span class="p">.</span><span class="nx">readyState</span><span class="p">);</span>
            <span class="p">});</span>
            <span class="nx">sourceBuffer</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;abort&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;abort: &#39;</span> <span class="o">+</span> <span class="nx">ms</span><span class="p">.</span><span class="nx">readyState</span><span class="p">);</span>
            <span class="p">});</span>

            <span class="nx">payload</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>

                <span class="c1">// chunk data</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>

                <span class="c1">// 버퍼에 내려받은 스트림 데이터를 할당한다.</span>
                <span class="nx">sourceBuffer</span><span class="p">.</span><span class="nx">appendBuffer</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>

            <span class="p">});</span>

            <span class="c1">// 데이터 전송이 완료되었을 경우 발생한다.</span>
            <span class="nx">payload</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;endOfStream call&#39;</span><span class="p">);</span>
                <span class="c1">// 스트림을 종료한다.</span>
                <span class="nx">ms</span><span class="p">.</span><span class="nx">endOfStream</span><span class="p">();</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></li>
<li><p>Server Side(use nodeJS)</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">ss</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;socket.io-stream&#39;</span><span class="p">);</span>

<span class="nx">ss</span><span class="p">(</span><span class="nx">socket</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;onSocketMsg&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>

        <span class="nx">data</span> <span class="o">=</span> <span class="nx">data</span> <span class="o">||</span> <span class="p">{};</span>

        <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">payload</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">payload</span><span class="p">;</span>

        <span class="kd">var</span> <span class="nx">stream</span> <span class="o">=</span> <span class="nx">ss</span><span class="p">.</span><span class="nx">createStream</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;downloadChunkVideo&#39;</span><span class="p">)</span> <span class="p">{</span>

            <span class="c1">// webm 포맷의 영상을 가져온다.</span>
            <span class="kd">var</span> <span class="nx">filename</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">basename</span><span class="p">(</span><span class="s1">&#39;feelings_vp9-20130806-244.webm&#39;</span><span class="p">);</span>
            <span class="c1">// 파일 스트림을 생성한다.</span>
            <span class="nx">fs</span><span class="p">.</span><span class="nx">createReadStream</span><span class="p">(</span><span class="nx">filename</span><span class="p">).</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">stream</span><span class="p">);</span>

            <span class="nx">ss</span><span class="p">(</span><span class="nx">socket</span><span class="p">).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;onSocketMsg&#39;</span><span class="p">,</span> <span class="p">{</span>
                <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;resultChunkVideoData&#39;</span><span class="p">,</span>
                <span class="nx">payload</span><span class="o">:</span> <span class="p">{</span>
                    <span class="nx">stream</span><span class="o">:</span> <span class="nx">stream</span>
                <span class="p">}</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">});</span>
</code></pre></div></li>
<li><p>테스트 결과</p>

<p><img src="http://mohwa.github.io/blog/assets/images/posts/bytesManipulation_11.jpg" alt=""></p></li>
</ul></li>
<li><p>참고 사이트</p>

<ul>
<li>Stream 모듈: <a href="https://github.com/nkzawa/socket.io-stream">socket.io-stream</a></li>
<li><a href="https://ko.wikipedia.org/wiki/WebM">WebM</a></li>
<li><a href="http://firejune.com/1788/%EC%9E%90%EB%B0%94%EC%8A%A4%ED%81%AC%EB%A6%BD%ED%8A%B8%EC%97%90%EC%84%9C%EC%9D%98+BLOB+%EA%B0%9D%EC%B2%B4?stext=blob">자바스크립트에서의 BLOB 객체</a></li>
<li><a href="http://html5-mediasource-api.googlecode.com/svn/tags/0.1/draft-spec/mediasource-draft-spec.html">Mediasource</a></li>
<li><a href="https://developer.mozilla.org/ko/docs/Web/API/MediaSource">MediaSource in MDN</a></li>
<li><a href="https://msdn.microsoft.com/en-us/library/dn254959(v=vs.85).aspx">MediaSource Object in MS</a></li>
<li><a href="https://msdn.microsoft.com/en-us/library/dn594470(v=vs.85).aspx">Media Source Extensions (MSE)</a></li>
<li><a href="https://html5-demos.appspot.com/static/media-source.html">Mediasource Chunk DEMO</a></li>
<li><a href="https://msdn.microsoft.com/ko-kr/library/Dn551368(v=VS.85).aspx">MPEG-DATA 스트리밍 플레이어 빌드 in MS</a></li>
<li><a href="https://simpl.info/video/offline/?1">simpl.info offline video</a></li>
<li><a href="http://megatuto.com/formation-HTML5.php?HTML5-Examples-Code=MediaSource+error:+This+SourceBuffer+has+been+removed+from+the+parent+media+source+Categorie+javascript+html5+media-source&amp;category=&amp;article=18543">MediaSource 소스 예제</a></li>
<li><a href="https://nodesource.com/blog/understanding-socketio">Socket IO Stream 코드 예제</a></li>
</ul></li>
</ul></li>
</ul>

  </div>
  <div data-count="10" id="recommend-article"></div>
</article>

<section class="post-footer">
  <div class="related-posts">
    <div class="related-posts-title"><h2>Related Posts</h2></div>
    <div class="related-posts-list">
      <ul>
        
          <!-- match 를 false 로 초기화한다 -->
          <!---->
          
          <!-- 현재 page.categories === category 와 동일하다면. -->
          
              <li><a href="/blog/javascript/2016/04/21/es6-object-literal/" title="ES6 object initializer">ES6 object initializer</a></li>
          
          
          <!---->
        
          <!-- match 를 false 로 초기화한다 -->
          <!---->
          
          <!-- 현재 page.categories === category 와 동일하다면. -->
          
              <li><a href="/blog/javascript/2016/03/24/es6-destructuring-assignment/" title="ES6 Destructuring assignment">ES6 Destructuring assignment</a></li>
          
          
          <!---->
        
          <!-- match 를 false 로 초기화한다 -->
          <!---->
          
          <!-- 현재 page.categories === category 와 동일하다면. -->
          
              <li><a href="/blog/javascript/2016/02/24/es6-const/" title="ES6 const">ES6 const</a></li>
          
          
          <!---->
        
          <!-- match 를 false 로 초기화한다 -->
          <!---->
          
          <!-- 현재 page.categories === category 와 동일하다면. -->
          
              <li><a href="/blog/javascript/2016/02/23/es6-let/" title="ES6 let">ES6 let</a></li>
          
          
          <!---->
        
          <!-- match 를 false 로 초기화한다 -->
          <!---->
          
          <!-- 현재 page.categories === category 와 동일하다면. -->
          
              <li><a href="/blog/javascript/2016/02/18/es6-arrow-function/" title="ES6 Arrow Function & This Test">ES6 Arrow Function & This Test</a></li>
          
          
          <!---->
        
          <!-- match 를 false 로 초기화한다 -->
          <!---->
          
          <!-- 현재 page.categories === category 와 동일하다면. -->
          
              <li><a href="/blog/javascript/2016/02/15/es6-class/" title="ES6 Class #1">ES6 Class #1</a></li>
          
          
          <!---->
        
          <!-- match 를 false 로 초기화한다 -->
          <!---->
          
          <!-- 현재 page.categories === category 와 동일하다면. -->
          
              <li><a href="/blog/javascript/2016/02/05/proto/" title="__proto__ 속성과 프로토타입 위임 과정">__proto__ 속성과 프로토타입 위임 과정</a></li>
          
          
          <!---->
        
      </ul>
    </div>
  </div>
</section>

<section class="comments">
    <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'mohwa'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</section>



      <div class="separator"></div>
    </div>
  </div>
  <footer>
    <section>
  <ul class="links">
      <li><a href="https://twitter.com/yanione" title="follow me" target="_blank"><i class="icon-twitter"></i></a></li>
      <li><a href="https://github.com/mohwa" title="github page" target="_blank"><i class="icon-github"></i></a></li>
  </ul>
<section>

  </footer>
  <script>
    <!-- Google Analytics -->
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-30470280-2', 'auto');
    ga('send', 'pageview');

    // include jekyll full text search
    // https://github.com/christian-fei/Simple-Jekyll-Search
    SimpleJekyllSearch({
      searchInput: document.getElementById('search-input'),
      resultsContainer: document.getElementById('results-container'),
      json: '/blog/search.json',
      searchResultTemplate: '<li><a href="{href}">{title}</a>&nbsp;&nbsp;&nbsp;{date}</li>',
      noResultsText: 'No results found'
    });

  </script>
  <script src="http://b.readtrend.com/j/s.js"></script>
</body>
</html>
