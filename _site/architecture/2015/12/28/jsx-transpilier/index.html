<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">

    <!-- viewport 설정 -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- keyword 설정 -->
    <meta name="keywords" content="architecture">
    <!-- description 설정 -->
    <meta name="description" content="JSXTransformer(in React) 소스 분석" />

    <!-- open graph 설정 -->
    <meta property="og:type" content="mohwa blog">
    <meta property="og:title" content="JSXTransformer(in React) 소스 분석">
    <meta property="og:description" content="JSXTransformer(in React) 소스 분석">
    <!--<meta property="og:image" content="http://mysite.com/myimage.jpg">-->
    <meta property="og:url" content="/blog">

    <meta name="copyright" content="by mohwa" />

    <!--<link href="/favicon.ico" rel="shortcut icon" type="image/x-icon" />-->

    <!-- google search console 설정 -->
    <link rel="alternate" hreflang="ko" href="http://mohwa.github.io" />
    <link rel="alternate" hreflang="ko" href="https://mohwa.github.io" />

    <link rel="stylesheet" href="/blog/assets/css/site.css" />
    <link rel="stylesheet" href="/blog/bower_components/highlightjs/styles/darkula.css">

    <script src="/blog/bower_components/jquery/dist/jquery.min.js" type="text/javascript"></script>
    <script src="/blog/bower_components/highlightjs/highlight.pack.min.js" type="text/javascript"></script>
    <script src="/blog/bower_components/purl/purl.js" type="text/javascript"></script>
    <!-- Script pointing to jekyll-search.js -->
    <script src="/blog/bower_components/simple-jekyll-search/dest/jekyll-search.js" type="text/javascript"></script>

    <title>JSXTransformer(in React) 소스 분석</title>

    <script type="text/javascript">

        // code highlight 적용
        // https://highlightjs.org/static/demo/
        $(document).ready(function() {
            $('pre code').each(function(i, block) {
                hljs.highlightBlock(block);
            });
        });
    </script>
</head>

<body>

  <div class="top-bar"></div>

  <div class="container">
    <div class="site">
      <header>
        <nav>
    <span style="float:left;">
        <a class="" href="/blog/">Home</a>
        <!--<a class="" href="/archive/">전체글</a>-->
        <!--<a class="" href="//github.com/nolboo/nolboo.github.io/wiki">번역글 위키</a>-->
    </span>
    <span style="float:right;">
        <div id="search-container" class="search-container">
            <input type="text" id="search-input" class="search-input" placeholder="search...">
        </div>
    </span>
</nav>

        <div class="pull-right right logo">
          <div class="name"></div>
          <!--<a href="/feed.xml"><img class="avatar" src="/images/rss.jpg" alt="RSS" /></a>-->
        </div>
      </header>
      <div class="separator"></div>
      <ul id="results-container" class="results-container"></ul>
      <article>
  <h1>
    JSXTransformer(in React) 소스 분석
  </h1>
  <div class="center">
    <p class="meta">28 Dec 2015</p>
  </div>



  <div class="post">
  <h2 id="1-jsxtransformer">1. <a href="https://facebook.github.io/react/blog/2015/06/12/deprecating-jstransform-and-react-tools.html">JSXTransformer</a></h2>

<ul>
<li><p>JSXTransformer 내부에서 사용되는 <a href="https://github.com/facebookarchive/esprima">Esprima-FB</a> 파서는 기존 <a href="https://github.com/ariya/esprima/tree/harmony">Esprima</a> 파서를 확장(<a href="https://github.com/facebook/jsx">JSX 명세</a>) 구현한 버전이다.</p>

<ul>
<li>현재 버전은 <span style="color:#c11f1f">15001.1001.0-dev-harmony-fb</span> 이며, 분석된 내용은 <span style="color:#c11f1f">13001.1001.0-dev-harmony-fb</span> 버전을 따른다.<p></li>
<li><a href="https://fbcdn-dragon-a.akamaihd.net/hphotos-ak-xtf1/t39.3284-6/11057100_835863049837306_1087123501_n.js">JSXTransformer CDN</a></li>
</ul></li>
<li><p>생성된 <a href="https://ko.wikipedia.org/wiki/%EA%B5%AC%EB%AC%B8_%EB%B6%84%EC%84%9D">Parse 트리</a> 구조는 모질라의 <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/SpiderMonkey/Parser_API">Parser AST</a> 인터페이스 명세를 따르고 있다.(or <strong>구현</strong>되어있다)<p></p>

<ul>
<li><p><a href="https://github.com/estree/estree/blob/master/spec.md#programs">Program Interface 명세</a></p>

<p><img src="/blog/assets/images/posts/20151228/jsx_1.png" alt=""></p></li>
</ul></li>
<li><p>소스상의 parser 옵션 수정하여, (파서를 통해)수집된 토큰을 반환받을 수 있다.<p></p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">getAstForSource</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">_astCache</span><span class="p">[</span><span class="nx">source</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">disableAstCache</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">_astCache</span><span class="p">[</span><span class="nx">source</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">ast</span> <span class="o">=</span> <span class="nx">esprima</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="p">{</span>
        <span class="c1">// 아래와 같이 tokens 속성을 추가 한다.</span>
        <span class="nx">tokens</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nx">comment</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nx">loc</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nx">range</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nx">sourceType</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">sourceType</span>
    <span class="p">});</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">disableAstCache</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">_astCache</span><span class="p">[</span><span class="nx">source</span><span class="p">]</span> <span class="o">=</span> <span class="nx">ast</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">ast</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p><img src="/blog/assets/images/posts/20151228/jsx_2.png" alt=""></p></li>
<li><p><a href="http://esprima.org/">Esprima 공식 홈페이지</a></p></li>
<li><p><a href="https://github.com/estree/estree">The ESTree Spec</a><p></p></li>
<li><p><a href="https://github.com/facebook/jsx/blob/master/AST.md">JSX Tree Spec</a></p></li>
</ul>

<h2 id="2-parse">2. 소스 수집 및 <a href="https://ko.wikipedia.org/wiki/%EA%B5%AC%EB%AC%B8_%EB%B6%84%EC%84%9D">Parse 트리</a> 가 생성되는 과정</h2>

<ul>
<li><p>아래 소스는 <em><a href="https://github.com/facebookarchive/esprima">Parser</a></em> 에 의해 파싱될 <span style="color:#c11f1f">원본 소스</span>이다.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="o">&lt;</span><span class="nx">script</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;text/jsx&quot;</span><span class="o">&gt;</span>

    <span class="kd">function</span> <span class="nx">A</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">){</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>

        <span class="kd">var</span> <span class="nx">elem</span> <span class="o">=</span> <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;&lt;</span><span class="err">/div&gt;;</span>

        <span class="k">return</span> <span class="nx">elem</span><span class="p">;</span>
    <span class="p">}</span>

<span class="o">&lt;</span><span class="err">/script&gt;</span>
</code></pre></div></li>
<li><p>소스 수집 과정</p>

<ul>
<li><p>기본적으로 <span style="color:#c11f1f"><em>text/jsx</em></span> 타입을 가진 <em>Script Element</em> 내부 소스(or 코드)는 브라우저에 의해 처리되지않는다.</p>
<div class="highlight"><pre><code class="language-html" data-lang="html">  <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/jsx&quot;</span><span class="nt">&gt;</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;이 실행 코드는 브라우저에 의해 처리되지 않는다....&#39;</span><span class="p">);</span>
  <span class="nt">&lt;/script&gt;</span>
</code></pre></div></li>
<li><p><span style="color:#c11f1f"><em>text/jsx</em></span> 타입을 가진 모든 <em>Script Element</em> 를 수집한다.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript">  <span class="kd">function</span> <span class="nx">runScripts</span><span class="p">()</span> <span class="p">{</span>

      <span class="kd">var</span> <span class="nx">scripts</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">);</span>

      <span class="c1">// Array.prototype.slice cannot be used on NodeList on IE8</span>
      <span class="kd">var</span> <span class="nx">jsxScripts</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">scripts</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="sr">/^text\/jsx(;|$)/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">scripts</span><span class="p">.</span><span class="nx">item</span><span class="p">(</span><span class="nx">i</span><span class="p">).</span><span class="nx">type</span><span class="p">))</span> <span class="p">{</span>
              <span class="nx">jsxScripts</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">scripts</span><span class="p">.</span><span class="nx">item</span><span class="p">(</span><span class="nx">i</span><span class="p">));</span>
          <span class="p">}</span>
      <span class="p">}</span>

      <span class="p">...</span> 

      <span class="c1">// loadScripts 함수를 호출하여, script element 내부에 포함된 원본 소스를 가져온다.    </span>
      <span class="nx">loadScripts</span><span class="p">(</span><span class="nx">jsxScripts</span><span class="p">);</span>
  <span class="p">}</span>
</code></pre></div></li>
<li><p>만약 inline code 로 작성된 경우에는 <em>script.innerHTML</em> 속성 값을 통해 소스를 가져오고, <em>script.src</em> 속성 값이 있는 경우에는 <span style="color:#c11f1f"><em>xhr</em></span> 을 통해 가져온다.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript">  <span class="c1">// script.src 속성 값이 있는 경우</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">script</span><span class="p">.</span><span class="nx">src</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">result</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">async</span><span class="o">:</span> <span class="nx">async</span><span class="p">,</span>
        <span class="nx">error</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nx">executed</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nx">content</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nx">loaded</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nx">url</span><span class="o">:</span> <span class="nx">script</span><span class="p">.</span><span class="nx">src</span><span class="p">,</span>
        <span class="nx">options</span><span class="o">:</span> <span class="nx">options</span>
    <span class="p">};</span>

    <span class="c1">// xhr 을 통해 해당 소스를 가져온다.    </span>
    <span class="nx">load</span><span class="p">(</span><span class="nx">script</span><span class="p">.</span><span class="nx">src</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span> <span class="p">{</span>

        <span class="nx">result</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">loaded</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="c1">// content === source code</span>
        <span class="nx">result</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">content</span> <span class="o">=</span> <span class="nx">content</span><span class="p">;</span>
        <span class="nx">check</span><span class="p">();</span>
    <span class="p">},</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">result</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">error</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="nx">check</span><span class="p">();</span>
    <span class="p">});</span>

<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

    <span class="c1">// inline code 로 작성된 경우..</span>
    <span class="nx">result</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">async</span><span class="o">:</span> <span class="nx">async</span><span class="p">,</span>
        <span class="nx">error</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nx">executed</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nx">content</span><span class="o">:</span> <span class="nx">script</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">,</span>
        <span class="nx">loaded</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nx">url</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nx">options</span><span class="o">:</span> <span class="nx">options</span>
    <span class="p">};</span>
<span class="p">}</span>  
</code></pre></div></li>
<li><p>수집된 <span style="color:#c11f1f">원본 소스</span>는 <em><a href="https://github.com/facebookarchive/esprima">Parser</a></em> 를 통해 <strong>파싱</strong>된 후, 새로운 <em>Script Element</em> 를 통해 로드 및 실행된다.</p>

<ul>
<li><em>즉 생성된 Script Element 에 할당된 소스는 <span style="color:#c11f1f">파싱된 소스</span>를 가리킨다.</em><p></li>
</ul>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript">  <span class="kd">function</span> <span class="nx">run</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>

      <span class="c1">// script element 를 생성한다.</span>
      <span class="kd">var</span> <span class="nx">scriptEl</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">);</span>
      <span class="c1">// transformCode 함수를 통해 파서가 호출된다.</span>
      <span class="nx">scriptEl</span><span class="p">.</span><span class="nx">text</span> <span class="o">=</span> <span class="nx">transformCode</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>

      <span class="c1">// 파서에 의해 파싱된 소스</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">scriptEl</span><span class="p">.</span><span class="nx">text</span><span class="p">);</span>

      <span class="c1">// header element 의 자식 element 로 추가 시킨다.</span>
      <span class="nx">headEl</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">scriptEl</span><span class="p">);</span>
  <span class="p">}</span>
</code></pre></div></li>
<li><p><span style="color:#c11f1f">파싱된 소스</span> 및 <span style="color:#c11f1f">원본 소스</span></p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// 파서를 통해 파싱된 소스</span>
<span class="kd">function</span> <span class="nx">A</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">){</span>

 <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>

 <span class="kd">var</span> <span class="nx">elem</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>

 <span class="k">return</span> <span class="nx">elem</span><span class="p">;</span>
<span class="p">}</span> 
</code></pre></div>
<p><img src="/blog/assets/images/posts/20151228/jsx_3.png" alt=""></p></li>
</ul></li>
<li><p><a href="https://ko.wikipedia.org/wiki/%EA%B5%AC%EB%AC%B8_%EB%B6%84%EC%84%9D">Parse 트리</a> 생성 과정</p>

<ul>
<li><p><span style="color:#6298c1">transformCode</span> 함수가 호출된 후, 여러 단계(<span style="color:#6298c1">transformReact</span>... , <span style="color:#6298c1">transform</span> 등)를 거쳐, esprima.parse 함수를 통해, <em>Parse</em> 트리(AST)를 생성하는 함수인 <span style="color:#6298c1">getAstForSource</span> 함수를 호출하게 된다.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">getAstForSource</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">_astCache</span><span class="p">[</span><span class="nx">source</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">disableAstCache</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">_astCache</span><span class="p">[</span><span class="nx">source</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="c1">// esprima 파서를 호출한다.(최종 파스 트리를 반환받는다)</span>
    <span class="kd">var</span> <span class="nx">ast</span> <span class="o">=</span> <span class="nx">esprima</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">comment</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nx">loc</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nx">range</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nx">sourceType</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">sourceType</span>
    <span class="p">});</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">disableAstCache</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">_astCache</span><span class="p">[</span><span class="nx">source</span><span class="p">]</span> <span class="o">=</span> <span class="nx">ast</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 생성된 파스 트리를 반환한다.</span>
    <span class="k">return</span> <span class="nx">ast</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></li>
<li><p>먼저 <span style="color:#6298c1">esprima.parse</span> 함수가 호출되면, (여러 단계를 거친 후...)<span style="color:#6298c1"> advance</span> 함수를 통해 <span style="color:#c11f1f">원본 소스</span>에 포함된 각 문자(Char)의 의미를 분석 후, 분리된 토큰(어휘)을 객체화 시킨다.(<em>내부적으로는 더 많은 단계를 거치게된다</em>)</p>

<ul>
<li><p><span style="color:#6298c1">advance</span> 함수 내부</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">advance</span><span class="p">()</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">ch</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">state</span><span class="p">.</span><span class="nx">inJSXChild</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">skipComment</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">// 소스 분석이 종료되는 시점</span>
    <span class="c1">// 현재 index(코드의 위치)가 length(포함된 소스의 전체 길이) 보다 크거나 같을경우</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">index</span> <span class="o">&gt;=</span> <span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Token</span><span class="p">.</span><span class="nx">EOF</span><span class="p">,</span>
            <span class="nx">lineNumber</span><span class="o">:</span> <span class="nx">lineNumber</span><span class="p">,</span>
            <span class="nx">lineStart</span><span class="o">:</span> <span class="nx">lineStart</span><span class="p">,</span>
            <span class="nx">range</span><span class="o">:</span> <span class="p">[</span><span class="nx">index</span><span class="p">,</span> <span class="nx">index</span><span class="p">]</span>
        <span class="p">};</span>
    <span class="p">}</span>

    <span class="c1">// state.inJSXChild 가 true 인 경우(tag 열림(&#39;&lt;&#39;) 상태가, 닫힘(&#39;&gt;&#39;) 상태로 변경되었을 경우)</span>
    <span class="c1">// 즉 div element 가 닫힘(&#39;&gt;&#39;) 문자로 인해 닫힌경우(단 열림(&#39;&lt;&#39;) 문자 뒤에 &#39;/&#39; 문자가 오는 경우는 제외된다)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">inJSXChild</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">advanceJSXChild</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">// 원본 소스에 포함된 각 문자(Char)를 아스키 코드로 변환한다.               </span>
    <span class="nx">ch</span> <span class="o">=</span> <span class="nx">source</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">index</span><span class="p">);</span>

    <span class="cm">/*</span>
<span class="cm">      변환된 아스키 코드를 식별 후, 각 token 객체를 생성한다.</span>
<span class="cm">    */</span>

    <span class="c1">// Very common: ( and ) and ;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">ch</span> <span class="o">===</span> <span class="mi">40</span> <span class="o">||</span> <span class="nx">ch</span> <span class="o">===</span> <span class="mi">41</span> <span class="o">||</span> <span class="nx">ch</span> <span class="o">===</span> <span class="mi">58</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">scanPunctuator</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">// String literal starts with single quote (#39) or double quote (#34).</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">ch</span> <span class="o">===</span> <span class="mi">39</span> <span class="o">||</span> <span class="nx">ch</span> <span class="o">===</span> <span class="mi">34</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">inJSXTag</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">scanJSXStringLiteral</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">scanStringLiteral</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">inJSXTag</span> <span class="o">&amp;&amp;</span> <span class="nx">isJSXIdentifierStart</span><span class="p">(</span><span class="nx">ch</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">scanJSXIdentifier</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">ch</span> <span class="o">===</span> <span class="mi">96</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">scanTemplate</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">// 해당 문자의 의미를 분석 후, 토큰 객체를 생성한다.</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">isIdentifierStart</span><span class="p">(</span><span class="nx">ch</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">scanIdentifier</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">// Dot (.) char #46 can also start a floating-point number, hence the need</span>
    <span class="c1">// to check the next character.</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">ch</span> <span class="o">===</span> <span class="mi">46</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">isDecimalDigit</span><span class="p">(</span><span class="nx">source</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">scanNumericLiteral</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">scanPunctuator</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">isDecimalDigit</span><span class="p">(</span><span class="nx">ch</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">scanNumericLiteral</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">// Slash (/) char #47 can also start a regex.</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">extra</span><span class="p">.</span><span class="nx">tokenize</span> <span class="o">&amp;&amp;</span> <span class="nx">ch</span> <span class="o">===</span> <span class="mi">47</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">advanceSlash</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">scanPunctuator</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></li>
</ul></li>
<li><p>예를들어, 위 <span style="color:#6298c1">isIdentifierStart</span> 함수로 해당 <span style="color:#c11f1f">아스키 코드</span>(문자)의 <a href="https://ko.wikibooks.org/wiki/%EC%8B%9D%EB%B3%84%EC%9E%90">의미</a>를 분석 후, <span style="color:#6298c1">scanIdentifier</span> 함수를 통해 <span style="color:#c11f1f">토큰</span>(어휘) 객체를 생성한다.</p>

<ul>
<li><p><span style="color:#6298c1">isIdentifierStart</span> 함수 내부</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript">  <span class="kd">function</span> <span class="nx">isIdentifierStart</span><span class="p">(</span><span class="nx">ch</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 해당 아스키 코드의 의미를 분석한다.</span>
      <span class="k">return</span> <span class="p">(</span><span class="nx">ch</span> <span class="o">===</span> <span class="mi">36</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">ch</span> <span class="o">===</span> <span class="mi">95</span><span class="p">)</span> <span class="o">||</span>  <span class="c1">// $ (dollar) and _ (underscore)</span>
          <span class="p">(</span><span class="nx">ch</span> <span class="o">&gt;=</span> <span class="mi">65</span> <span class="o">&amp;&amp;</span> <span class="nx">ch</span> <span class="o">&lt;=</span> <span class="mi">90</span><span class="p">)</span> <span class="o">||</span>         <span class="c1">// A..Z</span>
          <span class="p">(</span><span class="nx">ch</span> <span class="o">&gt;=</span> <span class="mi">97</span> <span class="o">&amp;&amp;</span> <span class="nx">ch</span> <span class="o">&lt;=</span> <span class="mi">122</span><span class="p">)</span> <span class="o">||</span>        <span class="c1">// a..z</span>
          <span class="p">(</span><span class="nx">ch</span> <span class="o">===</span> <span class="mi">92</span><span class="p">)</span> <span class="o">||</span>                    <span class="c1">// \ (backslash)</span>
          <span class="p">((</span><span class="nx">ch</span> <span class="o">&gt;=</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">Regex</span><span class="p">.</span><span class="nx">NonAsciiIdentifierStart</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">ch</span><span class="p">)));</span>
  <span class="p">}</span>
</code></pre></div></li>
<li><p><span style="color:#6298c1">scanIdentifier</span> 함수 내부</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript">  <span class="kd">function</span> <span class="nx">scanIdentifier</span><span class="p">()</span> <span class="p">{</span>

      <span class="kd">var</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">type</span><span class="p">;</span>

      <span class="nx">start</span> <span class="o">=</span> <span class="nx">index</span><span class="p">;</span>

      <span class="c1">// Backslash (char #92) starts an escaped character.</span>

      <span class="cm">/*</span>

<span class="cm">      // 토큰 타입</span>
<span class="cm">      Token = {</span>
<span class="cm">          BooleanLiteral: 1,</span>
<span class="cm">          EOF: 2,</span>
<span class="cm">          Identifier: 3,</span>
<span class="cm">          Keyword: 4,</span>
<span class="cm">          NullLiteral: 5,</span>
<span class="cm">          NumericLiteral: 6,</span>
<span class="cm">          Punctuator: 7,</span>
<span class="cm">          StringLiteral: 8,</span>
<span class="cm">          RegularExpression: 9,</span>
<span class="cm">          Template: 10,</span>
<span class="cm">          JSXIdentifier: 11,</span>
<span class="cm">          JSXText: 12</span>
<span class="cm">      };</span>

<span class="cm">      */</span>                          
      <span class="c1">// 식별된 토큰이 id 변수로 할당된다.               </span>
      <span class="c1">// 예: function(분리된 토큰 문자열)</span>
      <span class="nx">id</span> <span class="o">=</span> <span class="p">(</span><span class="nx">source</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">index</span><span class="p">)</span> <span class="o">===</span> <span class="mi">92</span><span class="p">)</span> <span class="o">?</span> <span class="nx">getEscapedIdentifier</span><span class="p">()</span> <span class="o">:</span> <span class="nx">getIdentifier</span><span class="p">();</span> 

      <span class="c1">// There is no keyword or literal with only one character.</span>
      <span class="c1">// Thus, it must be an identifier.</span>

      <span class="c1">// 해당 토큰 타입을 설정한다.(식별자, 키워드, 일부 literal(null, boolean))</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">id</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">type</span> <span class="o">=</span> <span class="nx">Token</span><span class="p">.</span><span class="nx">Identifier</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isKeyword</span><span class="p">(</span><span class="nx">id</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">type</span> <span class="o">=</span> <span class="nx">Token</span><span class="p">.</span><span class="nx">Keyword</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">id</span> <span class="o">===</span> <span class="s1">&#39;null&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">type</span> <span class="o">=</span> <span class="nx">Token</span><span class="p">.</span><span class="nx">NullLiteral</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">id</span> <span class="o">===</span> <span class="s1">&#39;true&#39;</span> <span class="o">||</span> <span class="nx">id</span> <span class="o">===</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">type</span> <span class="o">=</span> <span class="nx">Token</span><span class="p">.</span><span class="nx">BooleanLiteral</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">type</span> <span class="o">=</span> <span class="nx">Token</span><span class="p">.</span><span class="nx">Identifier</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="c1">// 생성된 토큰 객체를 반환한다.</span>
      <span class="k">return</span> <span class="p">{</span>
          <span class="nx">type</span><span class="o">:</span> <span class="nx">type</span><span class="p">,</span> <span class="c1">// 4(Keyword)</span>
          <span class="nx">value</span><span class="o">:</span> <span class="nx">id</span><span class="p">,</span> <span class="c1">// &#39;function&#39;</span>
          <span class="nx">lineNumber</span><span class="o">:</span> <span class="nx">lineNumber</span><span class="p">,</span> <span class="c1">// 3</span>
          <span class="nx">lineStart</span><span class="o">:</span> <span class="nx">lineStart</span><span class="p">,</span> <span class="c1">// 2</span>
          <span class="nx">range</span><span class="o">:</span> <span class="p">[</span><span class="nx">start</span><span class="p">,</span> <span class="nx">index</span><span class="p">]</span> <span class="c1">// 6, 14</span>
      <span class="p">};</span>
  <span class="p">}</span>
</code></pre></div>
<p><img src="/blog/assets/images/posts/20151228/jsx_4.png" alt=""></p></li>
</ul></li>
<li><p>생성된 <span style="color:#c11f1f">토큰</span>(어휘) 객체를 통해 <em>Parse</em>(AST) 트리 구성을 위한 <span style="color:#c11f1f">노드</span>가 구성된다.</p>

<ul>
<li><p><a href="https://github.com/estree/estree/blob/master/spec.md#functiondeclaration">FunctionDeclaration 명세</a></p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript">  <span class="kr">interface</span> <span class="nx">FunctionDeclaration</span> <span class="o">&lt;:</span> <span class="nb">Function</span><span class="p">,</span> <span class="nx">Declaration</span> <span class="p">{</span>
      <span class="c1">// 노드 타입</span>
      <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;FunctionDeclaration&quot;</span><span class="p">;</span>
      <span class="c1">// 해당 함수 선언식에 대한 식별자 정보</span>
      <span class="nx">id</span><span class="o">:</span> <span class="nx">Identifier</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></div></li>
<li><p><span style="color:#6298c1">parseFunctionDeclaration</span> 함수 내부</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">parseFunctionDeclaration</span><span class="p">()</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">body</span><span class="p">,</span> <span class="nx">token</span><span class="p">,</span> <span class="nx">tmp</span><span class="p">,</span> <span class="nx">firstRestricted</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">generator</span><span class="p">,</span> <span class="nx">isAsync</span><span class="p">,</span>
        <span class="nx">previousStrict</span><span class="p">,</span> <span class="nx">previousYieldAllowed</span><span class="p">,</span> <span class="nx">previousAwaitAllowed</span><span class="p">,</span>
        <span class="nx">marker</span> <span class="o">=</span> <span class="nx">markerCreate</span><span class="p">(),</span> <span class="nx">typeParameters</span><span class="p">;</span>

    <span class="nx">isAsync</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">matchAsync</span><span class="p">())</span> <span class="p">{</span>
        <span class="nx">lex</span><span class="p">();</span>
        <span class="nx">isAsync</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">expectKeyword</span><span class="p">(</span><span class="s1">&#39;function&#39;</span><span class="p">);</span>

    <span class="nx">generator</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">match</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">lex</span><span class="p">();</span>
        <span class="nx">generator</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">token</span> <span class="o">=</span> <span class="nx">lookahead</span><span class="p">;</span>

    <span class="nx">id</span> <span class="o">=</span> <span class="nx">parseVariableIdentifier</span><span class="p">();</span>

    <span class="p">...</span>

    <span class="nx">tmp</span> <span class="o">=</span> <span class="nx">parseParams</span><span class="p">(</span><span class="nx">firstRestricted</span><span class="p">);</span>
    <span class="nx">firstRestricted</span> <span class="o">=</span> <span class="nx">tmp</span><span class="p">.</span><span class="nx">firstRestricted</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">tmp</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">message</span> <span class="o">=</span> <span class="nx">tmp</span><span class="p">.</span><span class="nx">message</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="p">...</span>

    <span class="nx">body</span> <span class="o">=</span> <span class="nx">parseFunctionSourceElements</span><span class="p">();</span>

    <span class="p">...</span>

    <span class="c1">// 함수 선언식에 대한 Parse 트리 노드를 생성한다.</span>
    <span class="k">return</span> <span class="nx">markerApply</span><span class="p">(</span>
        <span class="nx">marker</span><span class="p">,</span>
        <span class="nx">delegate</span><span class="p">.</span><span class="nx">createFunctionDeclaration</span><span class="p">(</span>
            <span class="nx">id</span><span class="p">,</span>
            <span class="nx">tmp</span><span class="p">.</span><span class="nx">params</span><span class="p">,</span>
            <span class="nx">tmp</span><span class="p">.</span><span class="nx">defaults</span><span class="p">,</span>
            <span class="nx">body</span><span class="p">,</span>
            <span class="nx">tmp</span><span class="p">.</span><span class="nx">rest</span><span class="p">,</span>
            <span class="nx">generator</span><span class="p">,</span>
            <span class="kc">false</span><span class="p">,</span>
            <span class="nx">isAsync</span><span class="p">,</span>
            <span class="nx">tmp</span><span class="p">.</span><span class="nx">returnType</span><span class="p">,</span>
            <span class="nx">typeParameters</span>
        <span class="p">)</span>
    <span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p><img src="/blog/assets/images/posts/20151228/jsx_5.png" alt=""></p></li>
</ul></li>
<li><p>각 <span style="color:#c11f1f">노드</span>가 조합되어, 최종 <em>Parse</em> 트리가 생성된다.</p>

<p><img src="/blog/assets/images/posts/20151228/jsx_6.png" alt=""></p></li>
<li><p><span style="color:#6298c1">utils.append</span>, <span style="color:#6298c1">utils.catchup</span> 함수(또 다른 함수 등)로 각 <span style="color:#c11f1f">노드</span> 객체 및 <span style="color:#c11f1f">state</span> 등을 전달하여, 최종 결과물인 <span style="color:#c11f1f">파싱된 소스</span>를 만들어 간다.(즉 source buffer 를 채워나간다)</p>

<ul>
<li><p><span style="color:#6298c1">utils.append</span> 함수 내부</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript">  <span class="cm">/**</span>
<span class="cm">   * Appends a string of text to the buffer</span>
<span class="cm">   *</span>
<span class="cm">   * @param {string} str</span>
<span class="cm">   * @param {object} state</span>
<span class="cm">   */</span>
  <span class="kd">function</span> <span class="nx">append</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="nx">state</span><span class="p">)</span> <span class="p">{</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">sourceMap</span> <span class="o">&amp;&amp;</span> <span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">state</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">sourceMap</span><span class="p">.</span><span class="nx">addMapping</span><span class="p">({</span>
              <span class="nx">generated</span><span class="o">:</span> <span class="p">{</span> <span class="nx">line</span><span class="o">:</span> <span class="nx">state</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">bufferLine</span><span class="p">,</span> <span class="nx">column</span><span class="o">:</span> <span class="nx">state</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">bufferColumn</span> <span class="p">},</span>
              <span class="nx">original</span><span class="o">:</span> <span class="p">{</span> <span class="nx">line</span><span class="o">:</span> <span class="nx">state</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">sourceLine</span><span class="p">,</span> <span class="nx">column</span><span class="o">:</span> <span class="nx">state</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">sourceColumn</span> <span class="p">},</span>
              <span class="nx">source</span><span class="o">:</span> <span class="nx">state</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">sourceMapFilename</span>
          <span class="p">});</span>
          <span class="kd">var</span> <span class="nx">transformedLines</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">transformedLines</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">state</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">bufferLine</span> <span class="o">+=</span> <span class="nx">transformedLines</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
              <span class="nx">state</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">bufferColumn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="nx">state</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">bufferColumn</span> <span class="o">+=</span>
              <span class="nx">transformedLines</span><span class="p">[</span><span class="nx">transformedLines</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">buffer</span> <span class="o">+=</span> <span class="nx">str</span><span class="p">;</span>

      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">buffer</span><span class="p">);</span>
  <span class="p">}</span>
</code></pre></div></li>
<li><p><span style="color:#6298c1">utils.catchup</span> 함수 내부</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript">  <span class="cm">/**</span>
<span class="cm">   * Given a state fill the resulting buffer from the original source up to</span>
<span class="cm">   * the end</span>
<span class="cm">   *</span>
<span class="cm">   * @param {number} end</span>
<span class="cm">   * @param {object} state</span>
<span class="cm">   * @param {?function} contentTransformer Optional callback to transform newly</span>
<span class="cm">   *                                       added content.</span>
<span class="cm">   */</span>
  <span class="kd">function</span> <span class="nx">catchup</span><span class="p">(</span><span class="nx">end</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">contentTransformer</span><span class="p">)</span> <span class="p">{</span>

      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;utils.catchup 함수 호출&#39;</span><span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">state</span><span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;source position&#39;</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">position</span><span class="p">,</span> <span class="nx">end</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">end</span> <span class="o">&lt;</span> <span class="nx">state</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">position</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// cannot move backwards</span>
          <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">source</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">position</span><span class="p">,</span> <span class="nx">end</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">transformed</span> <span class="o">=</span> <span class="nx">updateIndent</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">state</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">sourceMap</span> <span class="o">&amp;&amp;</span> <span class="nx">transformed</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// record where we are</span>
          <span class="nx">state</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">sourceMap</span><span class="p">.</span><span class="nx">addMapping</span><span class="p">({</span>
              <span class="nx">generated</span><span class="o">:</span> <span class="p">{</span> <span class="nx">line</span><span class="o">:</span> <span class="nx">state</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">bufferLine</span><span class="p">,</span> <span class="nx">column</span><span class="o">:</span> <span class="nx">state</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">bufferColumn</span> <span class="p">},</span>
              <span class="nx">original</span><span class="o">:</span> <span class="p">{</span> <span class="nx">line</span><span class="o">:</span> <span class="nx">state</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">sourceLine</span><span class="p">,</span> <span class="nx">column</span><span class="o">:</span> <span class="nx">state</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">sourceColumn</span> <span class="p">},</span>
              <span class="nx">source</span><span class="o">:</span> <span class="nx">state</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">sourceMapFilename</span>
          <span class="p">});</span>

          <span class="c1">// record line breaks in transformed source</span>
          <span class="kd">var</span> <span class="nx">sourceLines</span> <span class="o">=</span> <span class="nx">source</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">);</span>
          <span class="kd">var</span> <span class="nx">transformedLines</span> <span class="o">=</span> <span class="nx">transformed</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">);</span>
          <span class="c1">// Add line break mappings between last known mapping and the end of the</span>
          <span class="c1">// added piece. So for the code piece</span>
          <span class="c1">//  (foo, bar);</span>
          <span class="c1">// &gt; var x = 2;</span>
          <span class="c1">// &gt; var b = 3;</span>
          <span class="c1">//   var c =</span>
          <span class="c1">// only add lines marked with &quot;&gt;&quot;: 2, 3.</span>
          <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">sourceLines</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">state</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">sourceMap</span><span class="p">.</span><span class="nx">addMapping</span><span class="p">({</span>
                  <span class="nx">generated</span><span class="o">:</span> <span class="p">{</span> <span class="nx">line</span><span class="o">:</span> <span class="nx">state</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">bufferLine</span><span class="p">,</span> <span class="nx">column</span><span class="o">:</span> <span class="mi">0</span> <span class="p">},</span>
                  <span class="nx">original</span><span class="o">:</span> <span class="p">{</span> <span class="nx">line</span><span class="o">:</span> <span class="nx">state</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">sourceLine</span><span class="p">,</span> <span class="nx">column</span><span class="o">:</span> <span class="mi">0</span> <span class="p">},</span>
                  <span class="nx">source</span><span class="o">:</span> <span class="nx">state</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">sourceMapFilename</span>
              <span class="p">});</span>
              <span class="nx">state</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">sourceLine</span><span class="o">++</span><span class="p">;</span>
              <span class="nx">state</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">bufferLine</span><span class="o">++</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="c1">// offset for the last piece</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">sourceLines</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">state</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">sourceLine</span><span class="o">++</span><span class="p">;</span>
              <span class="nx">state</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">bufferLine</span><span class="o">++</span><span class="p">;</span>
              <span class="nx">state</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">sourceColumn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
              <span class="nx">state</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">bufferColumn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="nx">state</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">sourceColumn</span> <span class="o">+=</span> <span class="nx">sourceLines</span><span class="p">[</span><span class="nx">sourceLines</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span>
          <span class="nx">state</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">bufferColumn</span> <span class="o">+=</span>
              <span class="nx">transformedLines</span><span class="p">[</span><span class="nx">transformedLines</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="nx">state</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">buffer</span> <span class="o">+=</span>
          <span class="nx">contentTransformer</span> <span class="o">?</span> <span class="nx">contentTransformer</span><span class="p">(</span><span class="nx">transformed</span><span class="p">)</span> <span class="o">:</span> <span class="nx">transformed</span><span class="p">;</span>

      <span class="nx">state</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="nx">end</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></div></li>
</ul>

<p><img src="/blog/assets/images/posts/20151228/jsx_7.png" alt=""></p></li>
</ul></li>
<li><p><span style="color:#6298c1">transform</span> 함수를 통해, 최종 <span style="color:#c11f1f">파싱된 소스</span>가 포함된 객체를 반환하여, <strong>소스 수집 과정</strong>에서 말한바와 같이 <em>Script Element</em> 를 통해 로드 및 실행된다.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">transform</span><span class="p">(</span><span class="nx">visitors</span><span class="p">,</span> <span class="nx">source</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>

    <span class="kd">var</span> <span class="nx">ast</span><span class="p">;</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="c1">// 파스 트리를 생성한다.</span>
        <span class="nx">ast</span> <span class="o">=</span> <span class="nx">getAstForSource</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">e</span><span class="p">.</span><span class="nx">message</span> <span class="o">=</span> <span class="s1">&#39;Parse Error: &#39;</span> <span class="o">+</span> <span class="nx">e</span><span class="p">.</span><span class="nx">message</span><span class="p">;</span>
        <span class="k">throw</span> <span class="nx">e</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">createState</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">ast</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">visitors</span> <span class="o">=</span> <span class="nx">visitors</span><span class="p">;</span>

    <span class="p">....</span>

    <span class="nx">traverse</span><span class="p">(</span><span class="nx">ast</span><span class="p">,</span> <span class="p">[],</span> <span class="nx">state</span><span class="p">);</span>

    <span class="nx">utils</span><span class="p">.</span><span class="nx">catchup</span><span class="p">(</span><span class="nx">source</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">state</span><span class="p">);</span>

    <span class="c1">// state.g.buffer: 최종 파싱된 소스</span>
    <span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="p">{</span><span class="nx">code</span><span class="o">:</span> <span class="nx">state</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">buffer</span><span class="p">,</span> <span class="nx">extra</span><span class="o">:</span> <span class="nx">state</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">extra</span><span class="p">};</span>

    <span class="p">....</span>

    <span class="c1">// 파싱된 소스(ret.code)를 포함하는 객체를 반환한다.</span>
    <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
<span class="p">}</span>  
</code></pre></div>
<p><img src="/blog/assets/images/posts/20151228/jsx_8.png" alt=""></p></li>
</ul>

<h2 id="3">3. 마치며</h2>

<ul>
<li><p>이 글은 <span style="color:#c11f1f">파서</span> 과정 중 <span style="color:#c11f1f">포인트</span>가 될만한 부분을 골라내어 분석한 글이며, 더 자세한 내용을 알기위해서는 더 깊이있는 <span style="color:#c11f1f">소스 분석</span>이 필요하다.</p></li>
<li><p>요즘 트렌드인 <a href="https://facebook.github.io/react/index.html">React</a> 사용 방법과는 크게 상관 부분이지만, <strong>JSXTransformer</strong> 와 같은, 자신만의 Transpiler(or 언어) 를 제작해보고 싶은 사람이라면, 한번쯤 <a href="https://fbcdn-dragon-a.akamaihd.net/hphotos-ak-xtf1/t39.3284-6/11057100_835863049837306_1087123501_n.js">이와 같은</a> 소스를 분석해보는것도 좋을 듯 하다.</p></li>
</ul>

  </div>
  <div data-count="10" id="recommend-article"></div>
</article>

<section class="post-footer">
  <div class="related-posts">
    <div class="related-posts-title"><h2>Related Posts</h2></div>
    <div class="related-posts-list">
      <ul>
        
          <!-- match 를 false 로 초기화한다 -->
          <!---->
          
          <!-- 현재 page.categories === category 와 동일하다면. -->
          
          
          <!---->
        
          <!-- match 를 false 로 초기화한다 -->
          <!---->
          
          <!-- 현재 page.categories === category 와 동일하다면. -->
          
          
          <!---->
        
          <!-- match 를 false 로 초기화한다 -->
          <!---->
          
          <!-- 현재 page.categories === category 와 동일하다면. -->
          
          
          <!---->
        
          <!-- match 를 false 로 초기화한다 -->
          <!---->
          
          <!-- 현재 page.categories === category 와 동일하다면. -->
          
          
          <!---->
        
          <!-- match 를 false 로 초기화한다 -->
          <!---->
          
          <!-- 현재 page.categories === category 와 동일하다면. -->
          
          
          <!---->
        
          <!-- match 를 false 로 초기화한다 -->
          <!---->
          
          <!-- 현재 page.categories === category 와 동일하다면. -->
          
          
          <!---->
        
          <!-- match 를 false 로 초기화한다 -->
          <!---->
          
          <!-- 현재 page.categories === category 와 동일하다면. -->
          
          
          <!---->
        
      </ul>
    </div>
  </div>
</section>

<section class="comments">
    <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'mohwa'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</section>



      <div class="separator"></div>
    </div>
  </div>
  <footer>
    <section>
  <ul class="links">
      <li><a href="https://twitter.com/yanione" title="follow me" target="_blank"><i class="icon-twitter"></i></a></li>
      <li><a href="https://github.com/mohwa" title="github page" target="_blank"><i class="icon-github"></i></a></li>
  </ul>
<section>

  </footer>
  <script>
    <!-- Google Analytics -->
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-30470280-2', 'auto');
    ga('send', 'pageview');

    // include jekyll full text search
    // https://github.com/christian-fei/Simple-Jekyll-Search
    SimpleJekyllSearch({
      searchInput: document.getElementById('search-input'),
      resultsContainer: document.getElementById('results-container'),
      json: '/blog/search.json',
      searchResultTemplate: '<li><a href="{href}">{title}</a>&nbsp;&nbsp;&nbsp;{date}</li>',
      noResultsText: 'No results found'
    });

  </script>
  <script src="http://b.readtrend.com/j/s.js"></script>
</body>
</html>
